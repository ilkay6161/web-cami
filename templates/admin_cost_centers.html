{% extends "base.html" %}

{% block title %}Admin - Kostenstellen verwalten{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<style>
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .card { transition: transform 0.2s; }
    .card:hover { transform: translateY(-5px); }
    .table-responsive { max-height: 500px; overflow-y: auto; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-5">
    <div class="row">
        <div class="col-12 px-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-building me-2"></i>Kostenstellen verwalten</h2>
                <a href="{{ url_for('admin_finanzen') }}" class="btn btn-primary">
                    <i class="fas fa-file-invoice-dollar me-2"></i>Zurück zu Finanzen
                </a>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="row">
                <div class="col-12">
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endwith %}

            <div class="card shadow fade-in mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Neue Kostenstelle hinzufügen</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('admin_cost_centers') }}" method="POST">
                        <input type="hidden" name="aktion" value="hinzufuegen_kostenstelle">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name der Kostenstelle</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
						<div class="mb-3">
							<label for="editCostCenterId" class="form-label">Kostenstelle</label>
							<select class="form-select" id="editCostCenterId" name="cost_center_id">
								<option value="">Keine</option>
								{% for cc in all_cost_centers %} <option value="{{ cc.id }}">{{ cc.name }}</option>
								{% endfor %}
							</select>
						</div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Beschreibung (optional)</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Kostenstelle hinzufügen</button>
                    </form>
                </div>
            </div>

            <div class="card shadow fade-in">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Vorhandene Kostenstellen</h5>
                </div>
                <div class="card-body">
                    {% if cost_centers %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="costCentersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Beschreibung</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cc in cost_centers %}
                                <tr>
                                    <td>{{ cc.id }}</td>
                                    <td>{{ cc.name }}</td>
                                    <td>{{ cc.description }}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success me-1" onclick="openAddProcessModal({{ cc.id }}, '{{ cc.name }}')">
                                            <i class="fas fa-plus me-1"></i>Vorgang hinzufügen
                                        </button>
                                        <button type="button" class="btn btn-sm btn-info me-1" onclick="openViewProcessesModal({{ cc.id }}, '{{ cc.name }}')">
                                            <i class="fas fa-eye me-1"></i>Vorgänge ansehen ({{ cc.processes|length }})
                                        </button>
                                        <form action="{{ url_for('admin_cost_centers') }}" method="POST" onsubmit="return confirmDelete({{ cc.id }}, '{{ cc.name }}');" style="display:inline-block;">
                                            <input type="hidden" name="aktion" value="loeschen_kostenstelle">
                                            <input type="hidden" name="cost_center_id" value="{{ cc.id }}">
                                            <button type="submit" class="btn btn-danger btn-sm">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">Keine Kostenstellen vorhanden.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addProcessModal" tabindex="-1" aria-labelledby="addProcessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProcessModalLabel">Neuen Vorgang hinzufügen für <span id="processCostCenterName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addProcessForm" action="{{ url_for('admin_cost_centers') }}" method="POST">
                    <input type="hidden" name="aktion" value="hinzufuegen_vorgang">
                    <input type="hidden" name="cost_center_id" id="addProcessCostCenterId">
                    <div class="mb-3">
                        <label for="process_name" class="form-label">Vorgangsname</label>
                        <input type="text" class="form-control" id="process_name" name="process_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="process_description" class="form-label">Beschreibung (optional)</label>
                        <textarea class="form-control" id="process_description" name="process_description" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Vorgang hinzufügen</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="viewProcessesModal" tabindex="-1" aria-labelledby="viewProcessesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewProcessesModalLabel">Vorgänge für <span id="viewProcessesCostCenterName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="processesList">
                    <p class="text-muted" id="noProcessesMessage" style="display: none;">Keine Vorgänge für diese Kostenstelle vorhanden.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script>
    // DataTable initialisieren
    $(document).ready(function() {
        $('#costCentersTable').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/de-DE.json'
            },
            pageLength: 10,
            lengthMenu: [5, 10, 25, 50],
            order: [[0, 'desc']],
            columnDefs: [
                { targets: -1, orderable: false } // Disable sorting for the last column (actions)
            ]
        });
    });

    // Function to open "Add Process" modal and set cost center ID
    function openAddProcessModal(costCenterId, costCenterName) {
        document.getElementById('addProcessCostCenterId').value = costCenterId;
        document.getElementById('processCostCenterName').textContent = costCenterName;
        // Clear previous input values when opening modal
        document.getElementById('process_name').value = '';
        document.getElementById('process_description').value = '';
        const addProcessModal = new bootstrap.Modal(document.getElementById('addProcessModal'));
        addProcessModal.show();
    }

    // Function to open "View Processes" modal and load processes
    function openViewProcessesModal(costCenterId, costCenterName) {
        document.getElementById('viewProcessesCostCenterName').textContent = costCenterName;
        const processesListDiv = document.getElementById('processesList');
        const noProcessesMessage = document.getElementById('noProcessesMessage');
        processesListDiv.innerHTML = '<p class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Vorgänge werden geladen...</p>';
        noProcessesMessage.style.display = 'none';

        fetch(`/admin/cost_centers/${costCenterId}/processes.json`)
            .then(response => response.json())
            .then(data => {
                processesListDiv.innerHTML = ''; // Clear loading message

                if (data.processes && data.processes.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'table table-striped table-hover';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Beschreibung</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    const tbody = table.querySelector('tbody');

                    data.processes.forEach(process => {
                        const row = tbody.insertRow();
                        row.insertCell().textContent = process.id;
                        row.insertCell().textContent = process.name;
                        row.insertCell().textContent = process.description || 'Keine Beschreibung';
                        
                        const actionsCell = row.insertCell();
                        actionsCell.innerHTML = `
                            <button type="button" class="btn btn-danger btn-sm" onclick="confirmDeleteProcess(${process.id}, '${process.name}')">
                                <i class="fas fa-trash"></i> Löschen
                            </button>
                        `;
                    });
                    processesListDiv.appendChild(table);
                } else {
                    noProcessesMessage.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading processes:', error);
                processesListDiv.innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Vorgänge.</div>';
            });
        
        const viewProcessesModal = new bootstrap.Modal(document.getElementById('viewProcessesModal'));
        viewProcessesModal.show();
    }

    // Löschaktion bestätigen für Kostenstelle
    function confirmDelete(costCenterId, name) {
        return confirm(`Möchten Sie die Kostenstelle \"${name}\" wirklich löschen? Alle zugehörigen Vorgänge und Transaktionen werden ebenfalls gelöscht.`);
    }

    // Function to confirm process deletion
    function confirmDeleteProcess(processId, processName) {
        if (confirm(`Möchten Sie den Vorgang "${processName}" wirklich löschen? Alle zugehörigen Transaktionen werden ebenfalls gelöscht.`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for('admin_cost_centers') }}'; // Submit back to the same route

            const aktionInput = document.createElement('input');
            aktionInput.type = 'hidden';
            aktionInput.name = 'aktion';
            aktionInput.value = 'loeschen_vorgang'; // Action to trigger deletion
            form.appendChild(aktionInput);

            const processIdInput = document.createElement('input');
            processIdInput.type = 'hidden';
            processIdInput.name = 'process_id';
            processIdInput.value = processId;
            form.appendChild(processIdInput);

            document.body.appendChild(form); // Append form to the body to submit
            form.submit();
        }
    }
</script>
{% endblock %}