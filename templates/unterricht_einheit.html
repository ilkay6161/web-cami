{% extends "base.html" %}
{% block title %}Unterrichtseinheit - {{ unterrichtseinheit.thema }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>Unterrichtseinheit: {{ unterrichtseinheit.thema }}</h1>
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Details</h5>
            <p><strong>Klasse:</strong> {{ klasse.name }} ({{ klasse.schuljahr }})</p>
            <p><strong>Datum:</strong> {{ unterrichtseinheit.datum.strftime('%d.%m.%Y') }}</p>
            <p><strong>Stunden:</strong> {{ unterrichtseinheit.stunden }}</p>
            <p><strong>Thema:</strong> {{ unterrichtseinheit.thema }}</p>
            <p><strong>Inhalte:</strong> {{ unterrichtseinheit.inhalte|default('Keine Inhalte angegeben.') }}</p>
            <p><strong>Bemerkung:</strong> {{ unterrichtseinheit.bemerkung|default('Keine Bemerkungen.') }}</p>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Anwesenheitsliste</h5>
            <form action="{{ url_for('anwesenheit_verwalten', unterricht_id=unterrichtseinheit.id) }}" method="POST">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Nachname</th>
                            <th>Vorname</th>
                            <th>Anwesend</th>
                            <th>Entschuldigt</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for schueler in schueler %}
                        <tr>
                            <td>{{ schueler.nachname }}</td>
                            <td>{{ schueler.name }}</td>
                            <td>
                                <input type="checkbox" name="anwesend_{{ schueler.id }}"
                                       {% if anwesenheits_data[schueler.id].anwesend|default(False) %}checked{% endif %}
                                       onchange="document.getElementById('entschuldigt_{{ schueler.id }}').disabled = this.checked;">
                            </td>
                            <td>
                                <input type="checkbox" name="entschuldigt_{{ schueler.id }}"
                                       id="entschuldigt_{{ schueler.id }}"
                                       {% if anwesenheits_data[schueler.id].entschuldigt|default(False) %}checked{% endif %}
                                       {% if anwesenheits_data[schueler.id].anwesend|default(False) %}disabled{% endif %}>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center">Keine Schüler in dieser Klasse.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-1"></i> Anwesenheit speichern
                    </button>
                </div>
            </form>
        </div>
    </div>
    <a href="{{ url_for('klassenbuch_details', klasse_id=klasse.id) }}" class="btn btn-secondary mt-3">
        <i class="fas fa-arrow-left me-1"></i> Zurück zur Klasse
    </a>
</div>

{% block extra_js %}
<script>
document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        if (this.name.startsWith('anwesend_')) {
            const schuelerId = this.name.split('_')[1];
            const entschuldigtCheckbox = document.getElementById(`entschuldigt_${schuelerId}`);
            if (this.checked) {
                entschuldigtCheckbox.checked = false;
                entschuldigtCheckbox.disabled = true;
            } else {
                entschuldigtCheckbox.disabled = false;
            }
        }
    });
});
</script>
{% endblock %}