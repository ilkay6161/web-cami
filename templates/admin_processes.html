{% extends "base.html" %}

{% block title %}Admin - Vorgänge für Kostenstelle {{ cost_center.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<style>
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .card { transition: transform 0.2s; }
    .card:hover { transform: translateY(-5px); }
    .table-responsive { max-height: 500px; overflow-y: auto; }
    .badge-table { display: inline-block; width: 80px; text-align: center; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-5">
    <div class="row">
        <div class="col-12 px-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tasks me-2"></i>Vorgänge für Kostenstelle: {{ cost_center.name }}</h2>
                <a href="{{ url_for('admin_finanzen') }}" class="btn btn-primary">
                    <i class="fas fa-file-invoice-dollar me-2"></i>Zurück zur Finanzübersicht
                </a>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="mb-4">
                {% for category, message in messages %}
                <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <div class="card mb-4 fade-in">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Neuen Vorgang erstellen</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('admin_processes', cost_center_id=cost_center.id) }}" method="POST">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label">Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" required 
                                       placeholder="z.B. Ramadan Spendenaktion, Gebäudeinstandhaltung">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="description" class="form-label">Beschreibung</label>
                                <textarea class="form-control" id="description" name="description" rows="3" 
                                          placeholder="Detaillierte Beschreibung des Vorgangs"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Vorgang erstellen
                        </button>
                    </form>
                </div>
            </div>

            <div class="card fade-in">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Vorgänge dieser Kostenstelle</h5>
                </div>
                <div class="card-body">
                    {% if processes %}
                    <div class="accordion" id="processesAccordion">
                        {% for process in processes %}
                        <div class="accordion-item mb-2">
                            <h2 class="accordion-header" id="process-heading-{{ process.id }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#process-collapse-{{ process.id }}" aria-expanded="false" 
                                        aria-controls="process-collapse-{{ process.id }}">
                                    {{ process.name }} (Bilanz: {{ process.balance|float|round(2) }} €)
                                </button>
                            </h2>
                            <div id="process-collapse-{{ process.id }}" class="accordion-collapse collapse" 
                                 aria-labelledby="process-heading-{{ process.id }}" data-bs-parent="#processesAccordion">
                                <div class="accordion-body">
                                    <p class="mb-2">{{ process.description or 'Keine Beschreibung' }}</p>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <span class="me-3">Einnahmen: {{ process.income|float|round(2) }} €</span>
                                            <span>Ausgaben: {{ process.expenses|float|round(2) }} €</span>
                                        </div>
                                        <div>
                                            <a href="{{ url_for('admin_process_edit', process_id=process.id) }}" 
                                               class="btn btn-sm btn-warning me-1" title="Vorgang bearbeiten">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form action="{{ url_for('admin_process_delete', process_id=process.id) }}" 
                                                  method="POST" style="display:inline;" 
                                                  onsubmit="return confirmProcessDelete({{ process.id }}, {{ process.name|tojson }})">
                                                <button type="submit" class="btn btn-sm btn-danger" title="Vorgang löschen">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>

                                    <h6 class="mb-3">Transaktionen für {{ process.name }}</h6>
                                    {% if process.transactions %}
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="transactionsTable-{{ process.id }}">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Beschreibung</th>
                                                    <th>Betrag</th>
                                                    <th>Typ</th>
                                                    <th>Kategorie</th>
                                                    <th>Datum</th>
                                                    <th>Aktionen</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for transaction in process.transactions %}
                                                <tr>
                                                    <td>{{ transaction.id }}</td>
                                                    <td>{{ transaction.description }}</td>
                                                    <td>
                                                        {% if transaction.type != 'note' %}
                                                            {{ transaction.amount|float|round(2) }} €
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if transaction.type == 'income' %}
                                                            <span class="badge bg-success badge-table">Einnahme</span>
                                                        {% elif transaction.type == 'expense' %}
                                                            <span class="badge bg-danger badge-table">Ausgabe</span>
                                                        {% else %}
                                                            <span class="badge bg-info badge-table">Notiz</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ transaction.category or 'Keine' }}</td>
                                                    <td>{{ transaction.date.strftime('%d.%m.%Y') if transaction.date else 'N/A' }}</td>
                                                    <td>
                                                        <a href="{{ url_for('admin_finanzen_edit', transaction_id=transaction.id) }}" 
                                                           class="btn btn-sm btn-warning me-1" title="Transaktion bearbeiten">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <form action="{{ url_for('admin_finanzen_loeschen', transaction_id=transaction.id) }}" 
                                                              method="POST" style="display:inline;" 
                                                              onsubmit="return confirmTransactionDelete({{ transaction.id }}, '{{ transaction.description|escape('js') }}')">
                                                            <button type="submit" class="btn btn-sm btn-danger" title="Transaktion löschen">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <p class="text-muted">Keine Transaktionen für diesen Vorgang.</p>
                                    {% endif %}

                                    <hr class="my-4">
                                    <h6 class="mb-3">Neue Transaktion für {{ process.name }} hinzufügen</h6>
                                    <form action="{{ url_for('admin_processes', cost_center_id=cost_center.id, process_id=process.id) }}" method="POST">
                                        <input type="hidden" name="process_id_for_transaction" value="{{ process.id }}">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="transaction_description-{{ process.id }}" class="form-label">Beschreibung <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="transaction_description-{{ process.id }}" name="description" required 
                                                       placeholder="z.B. Spende erhalten, Materialkosten">
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="transaction_amount-{{ process.id }}" class="form-label">Betrag (€)</label>
                                                <input type="number" step="0.01" class="form-control" id="transaction_amount-{{ process.id }}" name="amount" 
                                                       placeholder="z.B. 50.00">
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="transaction_type-{{ process.id }}" class="form-label">Typ <span class="text-danger">*</span></label>
                                                <select class="form-select" id="transaction_type-{{ process.id }}" name="type" required onchange="toggleAmountField(this, 'transaction_amount-{{ process.id }}')">
                                                    <option value="income">Einnahme</option>
                                                    <option value="expense">Ausgabe</option>
                                                    <option value="note">Notiz</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="transaction_category-{{ process.id }}" class="form-label">Kategorie</label>
                                                <input type="text" class="form-control" id="transaction_category-{{ process.id }}" name="category" 
                                                       list="categorySuggestions" placeholder="z.B. Spenden, Miete">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="transaction_date-{{ process.id }}" class="form-label">Datum <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="transaction_date-{{ process.id }}" name="date" required 
                                                       value="{{ today.strftime('%Y-%m-%d') }}">
                                            </div>
                                            <div class="col-md-4 mb-3 d-flex align-items-end">
                                                <button type="submit" class="btn btn-success w-100">
                                                    <i class="fas fa-plus me-2"></i>Transaktion hinzufügen
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">Keine Vorgänge für diese Kostenstelle vorhanden.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script>
    // Initialize DataTables for each transaction table
    document.querySelectorAll('table[id^="transactionsTable"]').forEach(table => {
        $(table).DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/de-DE.json'
            },
            pageLength: 5,
            lengthMenu: [5, 10, 25],
            order: [[0, 'desc']],
            columnDefs: [
                { targets: -1, orderable: false }
            ]
        });
    });

    // Confirm delete action for processes
    function confirmProcessDelete(processId, name) {
        return confirm(`Möchten Sie den Vorgang "${name}" wirklich löschen? Alle zugehörigen Transaktionen werden ebenfalls gelöscht.`);
    }

    // Confirm delete action for transactions
    function confirmTransactionDelete(transactionId, description) {
        return confirm(`Möchten Sie die Transaktion "${description}" wirklich löschen?`);
    }

    // Toggle amount field based on transaction type
    function toggleAmountField(selectElement, amountInputId) {
        const amountInput = document.getElementById(amountInputId);
        if (selectElement.value === 'note') {
            amountInput.disabled = true;
            amountInput.value = '';
        } else {
            amountInput.disabled = false;
        }
    }

    // Set today's date for new transaction forms
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}`;

        document.querySelectorAll('input[id^="transaction_date-"]').forEach(input => {
            if (!input.value) { // Only set if not already set by Jinja
                input.value = formattedDate;
            }
        });
    });
</script>
{% endblock %}